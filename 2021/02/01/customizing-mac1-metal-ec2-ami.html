<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Customizing mac1.metal EC2 AMI — new guts, more glory" /><meta name="author" content="Serhii Vasylenko" /><meta property="og:locale" content="en_US" /><meta name="description" content="How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer" /><meta property="og:description" content="How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer" /><link rel="canonical" href="https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html" /><meta property="og:url" content="https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html" /><meta property="og:site_name" content="Serhii Vasylenko" /><meta property="og:image" content="https://serhii.vasylenko.info/assets/posts/2021-02-01-customizing-mac1-metal-ec2-ami/cover.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-01T00:00:00+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://serhii.vasylenko.info/assets/posts/2021-02-01-customizing-mac1-metal-ec2-ami/cover.png" /><meta property="twitter:title" content="Customizing mac1.metal EC2 AMI — new guts, more glory" /><meta name="twitter:site" content="@vasylenko" /><meta name="twitter:creator" content="@Serhii Vasylenko" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"How to build mac1.metal Instance AMI for CI/CD using Ansible and Packer","mainEntityOfPage":{"@type":"WebPage","@id":"https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html"},"@type":"BlogPosting","url":"https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html","image":"https://serhii.vasylenko.info/assets/posts/2021-02-01-customizing-mac1-metal-ec2-ami/cover.png","headline":"Customizing mac1.metal EC2 AMI — new guts, more glory","dateModified":"2021-02-01T00:00:00+02:00","datePublished":"2021-02-01T00:00:00+02:00","author":{"@type":"Person","name":"Serhii Vasylenko"},"@context":"https://schema.org"}</script><title>Customizing mac1.metal EC2 AMI — new guts, more glory | Serhii Vasylenko</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Serhii Vasylenko</a></div><div class="site-subtitle font-italic">Personal blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags.html" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives.html" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about.html" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vasylenko" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/vasylenko" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mail-from-blog','vasylenko.info'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Customizing mac1.metal EC2 AMI — new guts, more glory</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Customizing mac1.metal EC2 AMI — new guts, more glory</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Feb 1, 2021, 12:00 AM +0200" > Feb 1 <i class="unloaded">2021-02-01T00:00:00+02:00</i> </span> by <span class="author"> Serhii Vasylenko </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1287 words">7 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/2021-02-01-customizing-mac1-metal-ec2-ami/cover.png" class="preview-img"><p>I guess macOS was designed for a user, not for the ops or engineers, so this is why its customization and usage for CI/CD are not trivial (compared to something Linux-based). A smart guess, huh?</p><h1 id="configuration-management">Configuration Management</h1><p>Native Apple’s Mobile device management (a.k.a MDM) and Jamf is probably the most potent combination for macOS configuration. But as much as it’s mighty, it is a cumbersome combination, and Jamf is not free.</p><p>Then we have Ansible, Chef, Puppet, SaltStack — they all are good with Linux, but what about macOS?</p><p>I tried to search for use cases of mentioned CM tools for macOS. However, I concluded that they wrap the execution of native macOS command-line utilities most of the time.</p><p>And if you search for the ‘macos’ word in Chef Supermarket or Puppet Forge, you won’t be impressed by the number of actively maintained packages. Although, here is a motivating article about using Chef <a href="https://pspdfkit.com/blog/2016/chef-on-macos/">automating-macos-provisioning-with-chef</a> if you prefer it. I could not find something similar and fresh for Puppet, so I am sorry, Puppet fans.</p><p>That is why I decided to follow the KISS principle and chose Ansible.</p><p>It’s easy to write and read the configuration, it allows to group tasks and to add execution logic <del>, and it feels more DevOps executing shell commands inside Ansible tasks instead of shell scripts; I know you know that 😂</del></p><p>By the way, Ansible Galaxy does not have many management packages for macOS, either. But thankfully, it has the basics:</p><ul><li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_module.html#ansible-collections-community-general-homebrew-module">homebrew</a> with <a href="https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_cask_module.html#ansible-collections-community-general-homebrew-cask-module">homebrew_cask</a> and <a href="https://docs.ansible.com/ansible/latest/collections/community/general/homebrew_tap_module.html#ansible-collections-community-general-homebrew-tap-module">homebrew_tap</a> — to install software<li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/launchd_module.html#ansible-collections-community-general-launchd-module">launchd</a> — to manage services<li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/osx_defaults_module.html#ansible-collections-community-general-osx-defaults-module">osx_defaults</a> — to manage some user settings (not all!)</ul><p>I used Ansible to build the macOS AMI for CI/CD, so here are some tips for such a case.</p><p><em>Some values are hardcoded intentionally in the code examples for the sake of simplicity and easy reading. You would probably want to parametrize them.</em></p><h2 id="xcode-installation-example">Xcode installation example</h2><p>The following tasks will help you to automate the basics.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Xcode</span>
      <span class="s">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xip</span><span class="nv"> </span><span class="s">--expand</span><span class="nv"> </span><span class="s">Xcode.xip"</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">chdir</span><span class="pi">:</span> <span class="s">/Applications</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Accept License Agreement</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild</span><span class="nv"> </span><span class="s">-license</span><span class="nv"> </span><span class="s">accept"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Accept License Agreement</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild</span><span class="nv"> </span><span class="s">-runFirstLaunch"</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Switch into newly installed Xcode context</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">xcode-select</span><span class="nv"> </span><span class="s">--switch</span><span class="nv"> </span><span class="s">/Applications/Xcode.app/Contents/Developer"</span>
</pre></table></code></div></div><h2 id="example-of-software-installation-with-brew">Example of software installation with Brew</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install common build software</span>
  <span class="s">community.general.homebrew</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">state</span><span class="pi">:</span> <span class="s">latest</span>
  <span class="na">loop</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">swiftlint</span>
    <span class="pi">-</span> <span class="s">swiftformat</span>
    <span class="pi">-</span> <span class="s">wget</span>
</pre></table></code></div></div><h2 id="screensharing-remote-desktop-configuration-example">ScreenSharing (remote desktop) configuration example</h2><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Turn On Remote Management</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./kickstart</span><span class="nv"> </span><span class="s">-activate</span><span class="nv"> </span><span class="s">-configure</span><span class="nv"> </span><span class="s">-allowAccessFor</span><span class="nv"> </span><span class="s">-specifiedUsers"</span>
  <span class="na">args</span><span class="pi">:</span>
    <span class="na">chdir</span><span class="pi">:</span> <span class="s">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable Remote Management for CI user</span>
  <span class="na">shell</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./kickstart</span><span class="nv"> </span><span class="s">-configure</span><span class="nv"> </span><span class="s">-users</span><span class="nv"> </span><span class="s">ec2-user</span><span class="nv"> </span><span class="s">-access</span><span class="nv"> </span><span class="s">-on</span><span class="nv"> </span><span class="s">-privs</span><span class="nv"> </span><span class="s">-all"</span>
  <span class="na">args</span><span class="pi">:</span>
    <span class="na">chdir</span><span class="pi">:</span> <span class="s">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/</span>
</pre></table></code></div></div><p>Shell rulez, yes.</p><h1 id="building-the-ami">Building the AMI</h1><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/2021-02-01-customizing-mac1-metal-ec2-ami/ami-build.gif" alt="" /></p><p><a href="https://www.packer.io/docs/builders/amazon/ebs">Packer by HashiCorp</a>, of course.</p><p>I would love to compare Packer with EC2 Image Builder, but it <a href="https://docs.aws.amazon.com/imagebuilder/latest/userguide/what-is-image-builder.html#image-builder-os">does not support macOS</a> yet (as of Feb’21).</p><p>Packer configuration is straightforward, so I want to highlight only the things specific to the “mac1.metal” use case.</p><h2 id="timeouts">Timeouts</h2><p>As I mentioned in the <a href="https://serhii.vasylenko.info/2021/01/19/mac1-metal-EC2-Instance-user-experience.html">previous article</a>, the creation and deletion time of the “mac1.metal” Instance is significantly bigger than Linux. That is why you should raise the polling parameters for the builder.</p><p>Example:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nl">"aws_polling"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"delay_seconds"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
        </span><span class="nl">"max_attempts"</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>And it would be best if you also increased the SSH timeout:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="w">  </span><span class="nl">"ssh_timeout"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1h"</span><span class="w">
</span></pre></table></code></div></div><p>Fortunately, Packer’s AMI builder does not require an explicit declaration of the Dedicated Host ID. So you can just reference the same subnet where you allocated the Host, assuming you did it with the enabled “Auto placement” parameter during the host creation.</p><p>Example:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="w">  </span><span class="nl">"tenancy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"host"</span><span class="err">,</span><span class="w">
  </span><span class="nl">"subnet_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"your-subnet-id"</span><span class="w">
</span></pre></table></code></div></div><h2 id="provisioning">Provisioning</h2><p>Packer has <a href="https://www.packer.io/docs/provisioners/ansible">Ansible Provisioner</a> that I used for the AMI. Its documentation is also very clean and straightforward.</p><p>But it is still worth mentioning that if you want to parametrize the Ansible playbook, then the following configuration example will be handy:</p><div class="language-json highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="w">  </span><span class="nl">"extra_arguments"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"--extra-vars"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"your-variable-foo=your-value-bar]"</span><span class="w">
  </span><span class="p">]</span><span class="err">,</span><span class="w">
  </span><span class="nl">"ansible_env_vars"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"ANSIBLE_PYTHON_INTERPRETER=auto_legacy_silent"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"ANSIBLE_OTHER_ENV_VARIABLE=other_value"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span></pre></table></code></div></div><h1 id="configuration-at-launch">Configuration at launch</h1><p>If you’re familiar with AWS EC2, you probably know what the Instance <code class="language-plaintext highlighter-rouge">user data</code> is.</p><p>A group of AWS developers made something similar for the macOS: <a href="https://github.com/aws/ec2-macos-init">EC2 macOS Init</a>.</p><p>It does not support <code class="language-plaintext highlighter-rouge">cloud-init</code> as on Linux-based Instances, but it can run shell scripts, which is quite enough.</p><p>EC2 macOS Init utility is a Launch Daemon (macOS terminology) that runs on behalf of the <code class="language-plaintext highlighter-rouge">root</code> user at system boot. It executes the commands according to the so-called Priority Groups, or the sequence in other words.</p><p>The number of the group corresponds to the execution order. You can put several tasks into a single Priority Group, and the tool will execute them simultaneously.</p><p>EC2 macOS Init uses a human-readable configuration file in <code class="language-plaintext highlighter-rouge">toml</code> format.</p><p>Example:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>[[Module]]
  Name = "Create-some-folder"
  PriorityGroup = 3
  FatalOnError = false 
  RunPerInstance = true 
  [Module.Command]
    Cmd = ["mkdir", "/Users/ec2-user/my-directory"] 
    RunAsUser = "ec2-user"
    EnvironmentVars = ["MY_VAR_FOO=myValueBar"]
</pre></table></code></div></div><p>I should clarify some things here.</p><p>Modules — a set of pre-defined modules for different purposes. It is something similar to the Ansible modules.</p><p>You can find the list of available modules here <a href="https://github.com/aws/ec2-macos-init/tree/master/lib/ec2macosinit">ec2-macos-init/lib/ec2macosinit</a></p><p>The <code class="language-plaintext highlighter-rouge">RunPerInstance</code> directive controls whether a module should run. There are three of such directives, and here is what they mean:</p><ul><li><code class="language-plaintext highlighter-rouge">RunPerBoot</code> — module will run at every system boot<li><code class="language-plaintext highlighter-rouge">RunPerInstance</code> — module will run once for the Instance. Each Instance has a unique ID; the init tool fetches it from the AWS API before the execution and keeps its execution history per Instance ID. When you create a new Instance from the AMI, it will have a unique ID, and the module will run again.<li><code class="language-plaintext highlighter-rouge">RunOnce</code> — module will run only once, despite the instance ID change</ul><p>I mentioned the execution history above. When EC2 macOS Init runs on the Instance first time, it creates a unique directory with the name per Instance ID to store the execution history and user data copy.</p><p><code class="language-plaintext highlighter-rouge">RunPerInstance</code> and <code class="language-plaintext highlighter-rouge">RunOnce</code> directives depend on the execution history, and modules with those directives will run again on the next boot if the previous execution failed. It was not obvious to me why RunOnce keeps repeating itself every boot until I dug into <a href="https://github.com/aws/ec2-macos-init/blob/master/lib/ec2macosinit/module.go#L110">the source code</a>.</p><p>Finally, there is a module for user data. It runs at the end by default (priority group #4) and pulls the user data script from AWS API before script execution.</p><p>I suggest looking into the default <a href="https://github.com/aws/ec2-macos-init/blob/master/configuration/init.toml">init.toml</a> configuration file to get yourself more familiar with the capabilities of the tool.</p><p>The init tool can also clear its history, which is useful for the new AMI creation.</p><p>Example:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ec2-macos-init clean <span class="nt">-all</span>
</pre></table></code></div></div><p>And you can run the init manually for debugging purposes.</p><p>Example:</p><div class="language-shell highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>ec2-macos-init run
</pre></table></code></div></div><p>You can also combine the EC2 macOS Init actions (made by modules) with your script in user data for more accurate nontrivial configurations.</p><h1 id="wrapping-up">Wrapping up</h1><p>As a whole, building and operating macOS-based AMI does not differ from AMI management for other platforms.</p><p>There are the same principle stages: prepare, clear, build, execute deployment script (if necessary). Though, the particular implementation of each step has its nuances and constraints.</p><p>So the whole process may look as follows:</p><ul><li>Provision and configure needed software with Ansible playbook<li>Clean-up system logs and EC2 macOS Init history (again, with Ansible task)<li>Create the AMI<li>Add more customizations at launch with EC2 macOS Init modules and user data (that also executes your Ansible playbook or shell commands)</ul><p>Getting into all this was both fun and interesting. Sometimes painful, though. 😆</p><p>I sincerely hope this article was helpful to you. Thank you for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technical-blogs/'>Technical Blogs</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/ansible/" class="post-tag no-text-decoration" >ansible</a> <a href="/tags/packer/" class="post-tag no-text-decoration" >packer</a> <a href="/tags/automation/" class="post-tag no-text-decoration" >automation</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Customizing mac1.metal EC2 AMI — new guts, more glory - Serhii Vasylenko&url=https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Customizing mac1.metal EC2 AMI — new guts, more glory - Serhii Vasylenko&u=https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Customizing mac1.metal EC2 AMI — new guts, more glory - Serhii Vasylenko&url=https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/fun/">fun</a> <a class="post-tag" href="/tags/getting-started/">getting started</a> <a class="post-tag" href="/tags/github/">github</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/2020/08/06/ansible-secrets-aws-ssm-sm.html"><div class="card-body"> <span class="timeago small" > Aug 6, 2020 <i class="unloaded">2020-08-06T00:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Managing Ansible playbook secrets with AWS services</h3><div class="text-muted small"><p> Lookup plugins for Ansible allow you to do a lot of cool things. One of them is to securely pass sensitive information to your playbooks. If you manage some apps in AWS with Ansible, then using Pa...</p></div></div></a></div><div class="card"> <a href="/2021/01/20/terraforming-mac1-metal-at-AWS.html"><div class="card-body"> <span class="timeago small" > Jan 20 <i class="unloaded">2021-01-20T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Terraforming mac1.metal at AWS</h3><div class="text-muted small"><p> Recently AWS announced the support for Mac mini instances. I believe this is huge, even despite the many constraints this solution has. Oh, and the price is as huge as the announcement as well. B...</p></div></div></a></div><div class="card"> <a href="/2020/12/16/aws-cloudshell.html"><div class="card-body"> <span class="timeago small" > Dec 16, 2020 <i class="unloaded">2020-12-16T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS CloudShell</h3><div class="text-muted small"><p> A simple but cool announcement from AWS — AWS CloudShell. A tool for ad-hoc AWS management via CLI directly in your browser. I like when AWS releases something simple to understand and yet powerfu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/2021/01/20/terraforming-mac1-metal-at-AWS.html" class="btn btn-outline-primary"><p>Terraforming mac1.metal at AWS</p></a> <a href="/2021/02/14/image-compression-with-tinypng-from-macos-contextual-menu.html" class="btn btn-outline-primary"><p>Using TinyPNG Image Compression From MacOS Finder Contextual Menu</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//serhii-vasylenko-info.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://serhii.vasylenko.info/2021/02/01/customizing-mac1-metal-ec2-ami.html'; this.page.identifier = '/2021/02/01/customizing-mac1-metal-ec2-ami.html'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/vasylenko">Serhii Vasylenko</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div><script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script> <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt=""/></noscript></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/fun/">fun</a> <a class="post-tag" href="/tags/getting-started/">getting started</a> <a class="post-tag" href="/tags/github/">github</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://serhii.vasylenko.info{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
