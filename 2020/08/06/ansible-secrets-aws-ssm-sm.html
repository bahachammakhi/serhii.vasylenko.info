<!DOCTYPE html><html lang="en" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Managing Ansible playbook secrets with AWS services" /><meta name="author" content="Serhii Vasylenko" /><meta property="og:locale" content="en_US" /><meta name="description" content="A quick guide to secure secrets management with Ansible in AWS" /><meta property="og:description" content="A quick guide to secure secrets management with Ansible in AWS" /><link rel="canonical" href="https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html" /><meta property="og:url" content="https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html" /><meta property="og:site_name" content="Serhii Vasylenko" /><meta property="og:image" content="https://serhii.vasylenko.info/assets/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-08-06T00:00:00+03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://serhii.vasylenko.info/assets/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png" /><meta property="twitter:title" content="Managing Ansible playbook secrets with AWS services" /><meta name="twitter:site" content="@vasylenko" /><meta name="twitter:creator" content="@Serhii Vasylenko" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"image":"https://serhii.vasylenko.info/assets/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png","description":"A quick guide to secure secrets management with Ansible in AWS","headline":"Managing Ansible playbook secrets with AWS services","dateModified":"2020-08-06T00:00:00+03:00","datePublished":"2020-08-06T00:00:00+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html"},"url":"https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html","author":{"@type":"Person","name":"Serhii Vasylenko"},"@context":"https://schema.org"}</script><title>Managing Ansible playbook secrets with AWS services | Serhii Vasylenko</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Serhii Vasylenko</a></div><div class="site-subtitle font-italic">Personal blog</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories.html" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags.html" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives.html" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about.html" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/vasylenko" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/vasylenko" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['mail-from-blog','vasylenko.info'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Managing Ansible playbook secrets with AWS services</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Managing Ansible playbook secrets with AWS services</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 6, 2020, 12:00 AM +0300" > Aug 6, 2020 <i class="unloaded">2020-08-06T00:00:00+03:00</i> </span> by <span class="author"> Serhii Vasylenko </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="444 words">2 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png" class="preview-img"><p>Lookup plugins for Ansible allow you to do a lot of cool things. One of them is to securely pass sensitive information to your playbooks. If you manage some apps in AWS with Ansible, then using Parameter Store or Secrets Manager along with it might greatly improve your security.</p><h2 id="variables-with-ssm-parameter-store">Variables with SSM Parameter Store</h2><p>Let’s say you have some variables defined in ‘defaults/main.yaml’ file of your role or maybe in group_vars.yaml file.</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="c1"># content of dev.vars.yaml to be included in your play or role</span>
<span class="na">use_tls</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">application_port</span><span class="pi">:</span> <span class="m">3000</span>
<span class="na">app_env</span><span class="pi">:</span> <span class="s">development</span>
<span class="na">stripe_api_key</span><span class="pi">:</span> <span class="s">1HGASU2eZvKYlo2CT5MEcnC39HqLyjWD</span>
</pre></table></code></div></div><p>If you store such things locally on Ansible control node, you probably encrypt it with <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">ansible-vault</a></p><p>SSM Parameter Store gives you more flexibility and security by centralized storage and management of parameters and secrets, so let’s use it with Ansible:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="c1"># content of dev.vars.yaml to be included in your play or role</span>
<span class="na">use_tls</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/use_tls')}}"</span>
<span class="na">application_port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/application_port')}}"</span>
<span class="na">app_env</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/app_env')}}"</span>
<span class="na">stripe_api_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/stripe_api_key')}}"</span>
</pre></table></code></div></div><p>The syntax is fairly simple:</p><p>The <code class="language-plaintext highlighter-rouge">aws_ssm</code> argument – is the name of plugin.</p><p>The <code class="language-plaintext highlighter-rouge">/dev/webserver/use_tls</code> argument – is the path to the key in Paramter Store.</p><p>Surely you can do the same for a group of servers with group variables, for example:</p><p>You can use this anywhere you can use templating: in a play, in variables file, or a Jinja2 template.</p><h2 id="variables-with-secret-manager">Variables with Secret Manager</h2><p>Another cool lookup plugin is Secrets Manager. In a nutshell, it has the same kind of functionality but it uses JSON format by feault.</p><p>Here is a quick example of its functionality in a Playbook:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nn">---</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Extract something secrets from Secret Manager</span>
  <span class="na">debug</span><span class="pi">:</span>
    <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">lookup('aws_secret',</span><span class="nv"> </span><span class="s">'dev/some-secrets')}}"</span>
</pre></table></code></div></div><p>The above task will generate the following output</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>TASK [Extract something secrets from Secret Manager] ****************************************************
ok: [some_server] =&gt; {
    "msg": {
        "dbname": "database",
        "engine": "mysql",
        "host": "127.0.0.1",
        "password": "password",
        "port": "3306",
        "username": "db_user"
    }
}
</pre></table></code></div></div><p>This is nice if you want to insert a JSON as is, but you will need additional parsing in case you want to get only some of JSON elements.</p><h2 id="conclusion">Conclusion</h2><p>If you’re using Ansible in CI/CD, then having it on an EC2 Instance with the IAM role will make you avoid keeping any secrets on that instance at all.<br /> The IAM role must allow at least the read access to SSM Parameter Store (+ KMS read access to be able to decrypt the keys) or the read access to Secrets Manager.</p><p>You can find documentation for described plugins here <a href="https://docs.ansible.com/ansible/latest/plugins/lookup/aws_ssm.html">aws_ssm</a> and here <a href="https://docs.ansible.com/ansible/latest/plugins/lookup/aws_secret.html">aws_secret</a>.</p><p>More about lookup plugins: https://docs.ansible.com/ansible/latest/plugins/lookup.html</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technical-blogs/'>Technical Blogs</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ansible/" class="post-tag no-text-decoration" >ansible</a> <a href="/tags/aws/" class="post-tag no-text-decoration" >aws</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Managing Ansible playbook secrets with AWS services - Serhii Vasylenko&url=https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Managing Ansible playbook secrets with AWS services - Serhii Vasylenko&u=https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Managing Ansible playbook secrets with AWS services - Serhii Vasylenko&url=https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <a href="/2020/05/02/Terraform-explained-for-managers.html" class="btn btn-outline-primary"><p>Terraform explained for managers</p></a> <a href="/2020/08/25/terraform-cli-shortcuts.html" class="btn btn-outline-primary"><p>Terraform CLI shortcuts</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="font-italic text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//serhii-vasylenko-info.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'https://serhii.vasylenko.info/2020/08/06/ansible-secrets-aws-ssm-sm.html'; this.page.identifier = '/2020/08/06/ansible-secrets-aws-ssm-sm.html'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/vasylenko">Serhii Vasylenko</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div><script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script> <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt=""/></noscript></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/terraform/">terraform</a> <a class="post-tag" href="/tags/automation/">automation</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/ansible/">ansible</a> <a class="post-tag" href="/tags/macos/">macos</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/cloudfront/">cloudfront</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/fun/">fun</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://serhii.vasylenko.info{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
